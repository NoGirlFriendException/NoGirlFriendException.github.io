<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>回龙观大金毛</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="website">
<meta property="og:title" content="回龙观大金毛">
<meta property="og:url" content="http://saberpowermo.github.io/index.html">
<meta property="og:site_name" content="回龙观大金毛">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="回龙观大金毛">
    

    

    

    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/vendor/open-sans/styles.css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/vendor/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/vendor/fancybox/jquery.fancybox.css">
    
    
        <script type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-6890412', 'auto');
ga('send', 'pageview');

</script>
    
    
    

</head>
<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">回龙观大金毛</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/avatar.png" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/avatar.png" />
            <h2 id="name">bb</h2>
            <h3 id="title">Developer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Beijing</span>
            <a id="follow" target="_blank" href="https://github.com/saberpowermo">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                15
                <span>posts</span>
            </div>
            <div class="article-info-block">
                5
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    <td><a href="https://github.com/saberpowermo" target="_blank" title="github"><i class="fa fa-github"></i></a></td>
                    
                    <td><a href="https://twitter.com/SABERPOWERbb" target="_blank" title="twitter"><i class="fa fa-twitter"></i></a></td>
                    
                    <td><a href="https://www.facebook.com/profile.php?id=100005632698168" target="_blank" title="facebook"><i class="fa fa-facebook"></i></a></td>
                    
                    <td><a href="/" target="_blank" title="dribbble"><i class="fa fa-dribbble"></i></a></td>
                    
                    <td><a href="/" target="_blank" title="rss"><i class="fa fa-rss"></i></a></td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-center-os-mysql" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/03/08/center-os-mysql/">center os 通过yum 安装 mysql 5.7</a>
        </h1>
    

                <div class="article-meta">
                    
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/03/08/center-os-mysql/">
            <time datetime="2019-03-08T06:58:30.000Z" itemprop="datePublished">2019-03-08</time>
        </a>
    </div>


                    
                    
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/server/">server</a>
    </div>

                </div>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <ol>
<li>下载 mysql 源安装包</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -LO http://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>安装 mysql 源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum localinstall mysql57-community-release-el7-11.noarch.rpm</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 mysql</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install mysql-community-server</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>一顿按 y 就可以了.</p>
<ol start="4">
<li><p>启动mysql</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 安装服务</span><br><span class="line">[root@localhost share]# sudo systemctl enable mysqld</span><br><span class="line">// 启动服务</span><br><span class="line">[root@localhost share]# sudo systemctl start mysqld</span><br><span class="line">// 查看服务状态</span><br><span class="line">[root@localhost share]# sudo systemctl status mysqld</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 root 默认密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MySQL 5.7 默认密码 在 /var/log/mysqld.log 文件中, 下面这个指令可以拿到默认指令.</span><br><span class="line">grep 'temporary password' /var/log/mysqld.log</span><br><span class="line">[Note] A temporary password is generated for root@localhost: **********</span><br><span class="line">登录 MySQL 并修改密码</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line">mysql&gt; ALTER USER 'root'@'localhost' IDENTIFIED BY '你自己的密码';</span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">6. 修改数据库默认字符</span><br><span class="line">```sql</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'character%'</span>;</span><br><span class="line">+<span class="comment">--------------------------+----------------------------+</span></span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+<span class="comment">--------------------------+----------------------------+</span></span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | utf8                       |</span><br><span class="line">| character_set_database   | latin1                     |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | latin1                     |</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+<span class="comment">--------------------------+----------------------------+</span></span><br></pre></td></tr></table></figure>
<p> 这是我的 mysql 安装以后默认的格式，一般我们实际工作中都是用 utf8mb4 格式.这里可以通过修改 /etc/my.conf 进行修改<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line">之后 插入以下的语句 即可修改</span><br><span class="line">[client]</span><br><span class="line">default-character-set = utf8mb4</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set = utf8mb4</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">character_set_server=utf8mb4</span><br></pre></td></tr></table></figure></p>
<ol start="7">
<li>允许远程访问<br>默认情况下 root 账号是不允许远端访问的<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; mysql&gt; select host,user  from user;</span><br><span class="line">+<span class="comment">-----------+---------------+</span></span><br><span class="line">| host      | user          |</span><br><span class="line">+<span class="comment">-----------+---------------+</span></span><br><span class="line">| localhost | mysql.session |</span><br><span class="line">| localhost | mysql.sys     |</span><br><span class="line">| localhost | root          |</span><br><span class="line">+<span class="comment">-----------+---------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>执行以下命令<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update user set host = '%' where user = 'root';</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br></pre></td></tr></table></figure></p>
<p>执行完之后 systemctl restart mysqld 重启服务 即可.</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://saberpowermo.github.io/2019/03/08/center-os-mysql/" data-id="cjszrxgub0002u4kp4rfzux6r" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="/2019/03/08/center-os-mysql/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="/2019/03/08/center-os-mysql/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-nginx_go_server" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/07/11/nginx_go_server/">nginx &amp;&amp; 定向本地静态资源 &amp;&amp; 反代 golang 服务 </a>
        </h1>
    

                <div class="article-meta">
                    
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/07/11/nginx_go_server/">
            <time datetime="2018-07-11T08:58:30.000Z" itemprop="datePublished">2018-07-11</time>
        </a>
    </div>


                    
                    
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/nginx/">nginx</a>
    </div>

                </div>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h3 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h3><p>这几天在公司的局域网服务器上申请了一个服务器, 准备没事整点自己没接触过的东西玩玩, 比如 nginx 等等</p>
<h3 id="开始折腾"><a href="#开始折腾" class="headerlink" title="开始折腾"></a>开始折腾</h3><p>申请到的服务器系统版本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.3.1611 (Core)</span><br></pre></td></tr></table></figure></p>
<h5 id="安装-nginx"><a href="#安装-nginx" class="headerlink" title="安装 nginx"></a>安装 nginx</h5><ol>
<li><p>添加CentOS 7 nginx yum资源库,打开终端,使用以下命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 yum 命令从 nginx 源服务器中获取来安装 nginx：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动 Nginx </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start nginx.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在基本上就可以通过IP地址 访问 nginx 的默认页面了<br>比如我的ip 是192.168.9.251<br>这个时候我在浏览器输入我的 ip, 就可以看到 nginx 的默认页面了</p>
</li>
</ol>
<p><img src="/images/nginx_default.png" alt=""></p>
<p>看到这个就代表nginx装好了</p>
<h5 id="期间遇见的一个问题"><a href="#期间遇见的一个问题" class="headerlink" title="期间遇见的一个问题"></a>期间遇见的一个问题</h5><p>启动服务器以后, 访问网页显示无法打开,去查了下发现是因为80端口没有开放.<br>首先：开启 web 端口<br>firewall-cmd –zone=public –add-port=80/tcp –permanent<br>然后重启 firewall<br>firewall-cmd –reload<br>搞定</p>
<h5 id="nginx-的一些基本命令和配置"><a href="#nginx-的一些基本命令和配置" class="headerlink" title="nginx 的一些基本命令和配置"></a>nginx 的一些基本命令和配置</h5><ul>
<li><p>默认的服务器 html 存放根目录是/usr/share/nginx/html.<br>可以 cd 到这个目录中去看到一些基础的 html, 比如 404.html, 和 index.html<br>可以把自己的网页放进这里面</p>
</li>
<li><p>默认的服务器模块配置文件位于<br>/etc/nginx/conf.d/default.conf.<br><img src="/images/nginx_defalut.conf.png" alt=""></p>
</li>
<li><p>nginx总的配置文件位于<br>/etc/nginx/nginx.conf.<br><img src="/images/nginx_conf.png" alt=""></p>
</li>
</ul>
<p>可以看到最后 那句 include 就是把我们刚才配的 /etc/nginx/conf.d/default.conf 引入进来</p>
<ul>
<li><p>nginx  重新加载配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>nginx 关闭服务<br>nginx -s stop</p>
</li>
</ul>
<h5 id="启动-go-服务"><a href="#启动-go-服务" class="headerlink" title="启动 go 服务"></a>启动 go 服务</h5><p>我在本机 使用 <a href="https://github.com/labstack/echo" target="_blank" rel="noopener">echo</a> 写了一个简单的 http server<br>比较关键的几个代码如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">s := &amp;http.Server&#123;</span><br><span class="line">	Addr:         &quot;:1323&quot;,</span><br><span class="line">	ReadTimeout:  20 * time.Minute,</span><br><span class="line">	WriteTimeout: 20 * time.Minute,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里是声明我这个服务 listen 1323端口.</p>
<p>这里是我声明了1个path group, 以 /me 打头<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">me := e.Group(&quot;/me&quot;)</span><br><span class="line">me.GET(&quot;/ping&quot;, func(c echo.Context) error &#123;</span><br><span class="line">	return c.String(200, &quot;Pong&quot;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>当别人访问 /me/ping 的时候 我会返回 1个Pong 的 response.</p>
<p>ok 代码很简单.<br>如果本机跑的话 直接go build  -&gt; ./main  或者go run main.go 就ok<br>但是因为我要部署到服务器centos系统上, 我本机是mac, 所以需要一些特殊操作, go 可以很轻松的支持这种跨平台编译<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build main.go</span><br></pre></td></tr></table></figure></p>
<p>这样就会生成1个可以在 centos 下 跑起来的二进制文件<br>通过 scp 命令 把该文件传到 我的服务器的某个路径上<br>运行该文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./usr/share/go/main &amp;</span><br></pre></td></tr></table></figure></p>
<p>这样我的服务器上就已经成功跑起来该服务了<br>访问 <a href="http://192.168.9.251:1323/me/ping" target="_blank" rel="noopener">http://192.168.9.251:1323/me/ping</a><br>可以收到 1个 pong 的 response.<br>前提依然是你的防火墙已经打开了 1323的端口</p>
<h5 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h5><p>我们先看看 正向代理 和 反向代理的 一些概念</p>
<h5 id="正向代理的概念"><a href="#正向代理的概念" class="headerlink" title="正向代理的概念"></a>正向代理的概念</h5><p>正向代理，也就是传说中的代理,他的工作原理就像一个跳板，简单的说，我是一个用户，我访问不了某网站，但是我能访问一个代理服务器，这个代理服务器呢，他能访问那个我不能访问的网站，于是我先连上代理服务器，告诉他我需要那个无法访问网站的内容，代理服务器去取回来，然后返回给我。从网站的角度，只在代理服务器来取内容的时候有一次记录，有时候并不知道是用户的请求，也隐藏了用户的资料，这取决于代理告不告诉网站。**       结论就是，正向代理 是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。</p>
<h5 id="反向代理的概念"><a href="#反向代理的概念" class="headerlink" title="反向代理的概念"></a>反向代理的概念</h5><p>用户访问  <a href="http://www.test.com/readme" target="_blank" rel="noopener">http://www.test.com/readme</a> ，但 <a href="http://www.test.com/" target="_blank" rel="noopener">www.test.com</a> 上并不存在readme页面，他是偷偷从另外一台服务器上取回来，然后作为自己的内容返回用户，但用户并不知情。这里所提到的  <a href="http://www.test.com/" target="_blank" rel="noopener">www.test.com</a>  这个域名对应的服务器就设置了反向代理功能。<br>结论就是，反向代理正好相反，对于客户端而言它就像是原始服务器，并且客户端不需要进行任何特别的设置。客户端向反向代理的命名空间(name-space)中的内容发送普通请求，接着反向代理将判断向何处(原始服务器)转交请求，并将获得的内容返回给客户端，就像这些内容原本就是它自己的一样。</p>
<h5 id="我的需求"><a href="#我的需求" class="headerlink" title="我的需求"></a>我的需求</h5><p>我服务器本身是不希望打开过多的端口, 希望外部访问这台机器的时候, 只通过80端口来接受 http 请求, 并且根据相应的规则分发到不同的端口<br>比如 <a href="http://192.168.9.251/me/ping" target="_blank" rel="noopener">http://192.168.9.251/me/ping</a><br>这样就可以 收到 pong 的 回应, 而不用 加上 :1323 的端口<br>nginx 实现这个需求非常简单<br>只需要 在 /etc/nginx/conf.d/default.conf 加入这个规则就好</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location /me &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:1323;</span><br><span class="line">    proxy_set_header   Host             $host;</span><br><span class="line">    proxy_set_header   X-Real-IP        $remote_addr;</span><br><span class="line">    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就是说 凡是 /me 的请求 都分发到本机的1323端口上<br>改完conf 之后, 执行  nginx -s reload<br>再次访问 <a href="http://192.168.9.251/me/ping" target="_blank" rel="noopener">http://192.168.9.251/me/ping</a><br>就能收到 我们来自 1323端口 go服务的 pong 的回应了</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://saberpowermo.github.io/2018/07/11/nginx_go_server/" data-id="cjszrxgum000bu4kphhkx1wp2" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="/2018/07/11/nginx_go_server/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="/2018/07/11/nginx_go_server/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-lottie" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/26/lottie/">Lottie 源码阅读.</a>
        </h1>
    

                <div class="article-meta">
                    
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/26/lottie/">
            <time datetime="2017-09-26T06:31:30.000Z" itemprop="datePublished">2017-09-26</time>
        </a>
    </div>


                    
                    
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Android/">Android</a>
    </div>

                </div>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h5 id="纯手打原创-转载请注明出处-感谢"><a href="#纯手打原创-转载请注明出处-感谢" class="headerlink" title="纯手打原创,转载请注明出处,感谢!"></a>纯手打原创,转载请注明出处,感谢!</h5><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a href="https://github.com/airbnb/lottie-android" target="_blank" rel="noopener">lottie-android</a></li>
<li><a href="https://medium.com/airbnb-engineering/introducing-lottie-4ff4a0afac0e" target="_blank" rel="noopener">introducing-lottie</a></li>
<li><a href="https://airbnb.design/lottie/" target="_blank" rel="noopener">design lottie</a></li>
<li><a href="https://github.com/bodymovin/bodymovin" target="_blank" rel="noopener">bodymovin</a></li>
<li><a href="https://medium.com/google-developers/animation-jump-through-861f4f5b3de4" target="_blank" rel="noopener">Animation: Jump-through</a></li>
<li><a href="https://facebookincubator.github.io/Keyframes/docs/keyframes/overview" target="_blank" rel="noopener">keyframes overview</a></li>
</ul>
<h3 id="概略介绍"><a href="#概略介绍" class="headerlink" title="概略介绍"></a>概略介绍</h3><p>Lottie is the native engine that Airbnb’s awesome team built. It uses Bodymovin as the animation exporter and is the ideal complement for getting animations to play natively everywhere. Follow these links to get each player:</p>
<ul>
<li><a href="https://github.com/airbnb/lottie-android" target="_blank" rel="noopener">Android’s player</a></li>
<li><a href="https://github.com/airbnb/lottie-ios" target="_blank" rel="noopener">iOS’s player</a></li>
<li><a href="https://github.com/airbnb/lottie-react-native" target="_blank" rel="noopener">React Native’s wrapper</a></li>
</ul>
<h3 id="官方效果图"><a href="#官方效果图" class="headerlink" title="官方效果图"></a>官方效果图</h3><p><img src="/images/lottie_test0.gif" alt=""></p>
<h3 id="整体开发流程"><a href="#整体开发流程" class="headerlink" title="整体开发流程"></a>整体开发流程</h3><p><img src="/images/lottie_%20flow.png" alt=""></p>
<p>如图所示，通过安装AE上的bodymovin的插件，能够将AE中的动画工程文件转换为通用的json格式描述文件(bodymovin插件本身是用于网页上呈现各种AE效果的一个开源库),lottie所做的事情就是实现在不同移动端平台上呈现AE动画的方式，从而达到动画文件的一次绘制、一次转换，随处可用的效果，这个跟Java一次编译随处运行效果一样</p>
<p>各平台 代码简单示范<br>android:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LottieAnimationView animationView = (LottieAnimationView) findViewById(R.id.animation_view);</span><br><span class="line">animationView.setAnimation(<span class="string">"hello-world.json"</span>);</span><br><span class="line">animationView.loop(<span class="keyword">true</span>);</span><br><span class="line">animationView.playAnimation();</span><br></pre></td></tr></table></figure></p>
<p>iOS:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LOTAnimationView *animation = [LOTAnimationView animationNamed:@<span class="string">"Lottie"</span>];</span><br><span class="line">[self.view addSubview:animation];</span><br><span class="line">[animation playWithCompletion:^(BOOL animationFinished) &#123;</span><br><span class="line">  <span class="comment">// Do Something</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p>WEB:<br><figure class="highlight javascript"><figcaption><span>1.8</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LOTAnimationView *animation = [LOTAnimationView animationNamed:@<span class="string">"Lottie"</span>];</span><br><span class="line">[self.view addSubview:animation];</span><br><span class="line">[animation playWithCompletion:^(BOOL animationFinished) &#123;</span><br><span class="line">  <span class="comment">// Do Something</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<h3 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h3><p>我们先从底层思考下如何在屏幕上绘制动画，最简单的方式是把动画分为多张图片，然后通过周期替换屏幕上绘制的图片来形成动画，这种暴力的方式非常简单，但缺点明显，很耗内存，动画播放中前后两张替换的图片在很多元素并没有变化，重复的内容浪费了空间。<br>为了提高空间利用率，可以把图片中的元素进行拆分，使用过photoshop的同学知道，其实在处理一张图片时，可以把一张复杂的图片使用多个图层来表示，每个图层上展示一部分内容，图层中的内容也可以拆分为多个元素。拆分元素之后，根据动画需求，可以单独对图层，甚至图层中的元素设置平移、旋转、收缩等动画。</p>
<p><img src="/images/lottie_test1.png" alt=""></p>
<p>Lottie使用json文件来作为动画数据源，json文件是通过Bodymovin插件导出的，查看sample中给出的json文件，其实就是把图片中的元素进行来拆分，并且描述每个元素的动画执行路径和执行时间。Lottie的功能就是读取这些数据，然后绘制到屏幕上。<br>现在思考如果我们拿到一份json格式动画如何展示到屏幕上。首先要解析json，建立数据到对象的映射，然后根据数据对象创建合适的Drawable绘制到View上，动画的实现可以通过操作读取到的元素完成。</p>
<p><img src="/images/lottie_test2.png" alt=""></p>
<h3 id="从android-源码解析"><a href="#从android-源码解析" class="headerlink" title="从android 源码解析"></a>从android 源码解析</h3><h4 id="项目结构图"><a href="#项目结构图" class="headerlink" title="项目结构图"></a>项目结构图</h4><p><img src="/images/Lottie%20%E7%BB%93%E6%9E%84%E5%9B%BE..png" alt=""></p>
<h6 id="该图因为太大了-所以有可能会看不清楚-感兴趣的同学可以下载到本地放大查看"><a href="#该图因为太大了-所以有可能会看不清楚-感兴趣的同学可以下载到本地放大查看" class="headerlink" title="该图因为太大了,所以有可能会看不清楚,感兴趣的同学可以下载到本地放大查看"></a>该图因为太大了,所以有可能会看不清楚,感兴趣的同学可以下载到本地放大查看</h6><h5 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h5><p>通过如下3个核心类来来完成整个工作流程，因而使用起来比较简单。以下是三个比较核心的类的说明：</p>
<ul>
<li>LottieComposition (json-&gt;数据对象)<br>Lottie使用LottieComposition来作为After Effects的数据对象，即把Json文件映射为到LottieComposition，该类中提供了解析json的静态方法。</li>
<li>LottieDrawable (数据对象-&gt;Drawable)<br>这个类是最上层使用的重要的一个类，动画的绘制就是由这个类来实现。</li>
<li>LottieAnimationView（绘制）<br>操作集合，LottieAnimationView 继承自 AppCompatImageView，封装了一些动画的操作，具体的绘制时委托为 LottieDrawable 完成的。<h6 id="数据解析"><a href="#数据解析" class="headerlink" title="数据解析"></a>数据解析</h6>数据的解析，主要参考 LottieComposition.fromJsonSync 方法：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LottieComposition <span class="title">fromJsonSync</span><span class="params">(Resources res, JSONObject json)</span> </span>&#123;</span><br><span class="line">  Rect bounds = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">float</span> scale = res.getDisplayMetrics().density;</span><br><span class="line">  <span class="keyword">int</span> width = json.optInt(<span class="string">"w"</span>, -<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">int</span> height = json.optInt(<span class="string">"h"</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (width != -<span class="number">1</span> &amp;&amp; height != -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> scaledWidth = (<span class="keyword">int</span>) (width * scale);</span><br><span class="line">    <span class="keyword">int</span> scaledHeight = (<span class="keyword">int</span>) (height * scale);</span><br><span class="line">    bounds = <span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">0</span>, scaledWidth, scaledHeight);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">long</span> startFrame = json.optLong(<span class="string">"ip"</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">long</span> endFrame = json.optLong(<span class="string">"op"</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">float</span> frameRate = (<span class="keyword">float</span>) json.optDouble(<span class="string">"fr"</span>, <span class="number">0</span>);</span><br><span class="line">  String version = json.optString(<span class="string">"v"</span>);</span><br><span class="line">  String[] versions = version.split(<span class="string">"[.]"</span>);</span><br><span class="line">  <span class="keyword">int</span> major = Integer.parseInt(versions[<span class="number">0</span>]);</span><br><span class="line">  <span class="keyword">int</span> minor = Integer.parseInt(versions[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">int</span> patch = Integer.parseInt(versions[<span class="number">2</span>]);</span><br><span class="line">  LottieComposition composition = <span class="keyword">new</span> LottieComposition(</span><br><span class="line">      bounds, startFrame, endFrame, frameRate, scale, major, minor, patch);</span><br><span class="line">  JSONArray assetsJson = json.optJSONArray(<span class="string">"assets"</span>);</span><br><span class="line">  parseImages(assetsJson, composition);</span><br><span class="line">  parsePrecomps(assetsJson, composition);</span><br><span class="line">  parseFonts(json.optJSONObject(<span class="string">"fonts"</span>), composition);</span><br><span class="line">  parseChars(json.optJSONArray(<span class="string">"chars"</span>), composition);</span><br><span class="line">  parseLayers(json, composition);</span><br><span class="line">  <span class="keyword">return</span> composition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>还有 parseImages、parsePrecomps、 parseLayers 这几个方法。<br>JSON文件的属性含义</p>
<p>动画描述文件是通过 bodymovin 插件导出来的，里面包含了动画的一切信息，包括了帧率，动画形态，如何做动画等。接下来将简单说明一下动画描述文件中的主要属性。</p>
<h6 id="最外部结构："><a href="#最外部结构：" class="headerlink" title="最外部结构："></a>最外部结构：</h6> <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "v": "4.6.2", // bodymovin的版本  </span><br><span class="line">  "fr": 25,  // 帧率  </span><br><span class="line">  "ip": 0,  // 起始关键帧</span><br><span class="line">  "op": 1000,  // 结束关键帧</span><br><span class="line">  "w": 720,  // 动画宽度</span><br><span class="line">  "h": 800,  // 动画高度</span><br><span class="line">  "nm": "合成 1",  </span><br><span class="line">  "ddd": 0,  </span><br><span class="line">  "assets":[],  // 动画图片资源信息</span><br><span class="line">  "layers":[] // 动画图层信息</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从这里可以获取 设计的动画的宽高，帧相关的信息，动画所需要的图片资源的信息以及图层信息。</p>
<h6 id="assets"><a href="#assets" class="headerlink" title="assets"></a>assets</h6><p>图片资源信息, 相关类 LottieImageAsset、 ImageAssetBitmapManager。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">"assets": [</span><br><span class="line">    &#123;</span><br><span class="line">      "id": "image_0",   // 图片id</span><br><span class="line">      "w": 58,  // 图片宽度</span><br><span class="line">      "h": 31,  // 图片高度</span><br><span class="line">      "u": "images/",</span><br><span class="line">      "p": "img_0.png"  // 图片名称</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h6 id="layers"><a href="#layers" class="headerlink" title="layers"></a>layers</h6><p>图层信息，相关类：Layer、BaseLayer以及 BaseLayer 的实现类。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"ddd"</span>: <span class="number">0</span>,</span><br><span class="line">    "ind": 0,  // layer id 图层 id</span><br><span class="line">    "ty": 2,  // layertype 图层类型</span><br><span class="line">    "nm": "btnSlice.png",  // layerName 图层信息</span><br><span class="line">    "cl": "png",</span><br><span class="line">    "refId": "image_0",  // 引用的资源 id,如果是 ImageLayer 那么就是图片的id</span><br><span class="line">    "ks": &#123;....&#125;,</span><br><span class="line">    "ao": 0,</span><br><span class="line">    "ip": 0,  // inFrame 该图层起始关键帧</span><br><span class="line">    "op": 90.0000036657751,  // outFrame 该图层结束关键帧</span><br><span class="line">    "st": 0,   // startFrame 开始</span><br><span class="line">    "bm": 0,</span><br><span class="line">    "sr": 1 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="播放动画"><a href="#播放动画" class="headerlink" title="播放动画"></a>播放动画</h5><p><img src="/images/lottie_draw_flow" alt=""></p>
<h5 id="官方说法"><a href="#官方说法" class="headerlink" title="官方说法"></a>官方说法</h5><ul>
<li>如果没有mask和mattes，那么性能和内存非常好，没有bitmap创建，大部分操作都是简单的cavas绘制。</li>
<li>如果存在mattes，将会创建2～3个bitmap。bitmap在动画加载到window时被创建，被window删除时回收。所以不宜在RecyclerView中使用包涵mattes或者mask的动画，否则会引起bitmap抖动。除了内存抖动，mattes和mask中必要的bitmap.eraseColor()和canvas.drawBitmap()也会降低动画性能。对于简单的动画，在实际使用时性能不太明显。</li>
<li>如果在列表中使用动画，推荐使用缓存LottieAnimationView.setAnimation(String, CacheStrategy) 。</li>
</ul>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://saberpowermo.github.io/2017/09/26/lottie/" data-id="cjszrxgui0006u4kp2u5g5ym9" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="/2017/09/26/lottie/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="/2017/09/26/lottie/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-volley" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/14/volley/">Volley 源码阅读.</a>
        </h1>
    

                <div class="article-meta">
                    
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/14/volley/">
            <time datetime="2017-09-14T06:31:30.000Z" itemprop="datePublished">2017-09-14</time>
        </a>
    </div>


                    
                    
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Android/">Android</a>
    </div>

                </div>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h5 id="纯手打原创-转载请注明出处-感谢"><a href="#纯手打原创-转载请注明出处-感谢" class="headerlink" title="纯手打原创,转载请注明出处,感谢!"></a>纯手打原创,转载请注明出处,感谢!</h5><p>Volley项目是大概3年前谷歌出的一套网络访问框架,从出来之后我就接触过并在项目中有使用过,但是一直都是浅尝的使用,没有认认真真的去读过内部结构,<br>最近项目结束了一个版本,接着这个间隙我准备去重新读下这个三年前出来的代码.</p>
<h4 id="Class-Volley"><a href="#Class-Volley" class="headerlink" title="Class Volley"></a>Class Volley</h4><p>Volley暴露出给我们最直接的类就是Volley这个类,其中有一个newRequestQueue的方法,来为我们创建一个RequestQueue.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RequestQueue mQueue = Volley.newRequestQueue(context);</span><br></pre></td></tr></table></figure></p>
<p>我们就跟着这个方法开始读代码.</p>
<h4 id="Class-RequestQueue"><a href="#Class-RequestQueue" class="headerlink" title="Class RequestQueue"></a>Class RequestQueue</h4><p>这个类是比较关键的一个入口,该类的API告诉我们,这是一个Request 发送的队列, dispatchers 工作在线程池里.<br>我们可以使用 add(Request) 把一个我们希望的Request请求 加入队列中, 它会在在工作线程中从缓存中或者网络中解析这个请求,<br>并且从主线程传递出一个解析好的 Response.<br>其中RequestQueue的构造方法是<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates the worker pool. Processing will not begin until &#123;<span class="doctag">@link</span> #start()&#125; is called.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cache A Cache to use for persisting responses to disk</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> network A Network interface for performing HTTP requests</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> threadPoolSize Number of network dispatcher threads to create</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> delivery A ResponseDelivery interface for posting responses and errors</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RequestQueue</span><span class="params">(Cache cache, Network network, <span class="keyword">int</span> threadPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">        ResponseDelivery delivery)</span> </span>&#123;</span><br><span class="line">    mCache = cache;</span><br><span class="line">    mNetwork = network;</span><br><span class="line">    mDispatchers = <span class="keyword">new</span> NetworkDispatcher[threadPoolSize];</span><br><span class="line">    mDelivery = delivery;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出这个队列需要以下四个初始化参数</p>
<ul>
<li>用于把response缓存在磁盘的策略.</li>
<li>一种履行Http请求的实现. </li>
<li>用来发送网络请求的线程数量</li>
<li>一种发送responses 和 errors的实现.<br>其中Cache Network ResponseDelivery 都是Interface,  我们暂且只看他的工作流程不去看具体Impl,后面再回来看具体实现.<br>当我们根据APi指示,调用RequestQueue的Start方法时,RequestQueue 才会真正开始工作.<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Starts the dispatchers in this queue.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    stop();  <span class="comment">// Make sure any currently running dispatchers are stopped.</span></span><br><span class="line">    <span class="comment">// Create the cache dispatcher and start it.</span></span><br><span class="line">    mCacheDispatcher = <span class="keyword">new</span> CacheDispatcher(mCacheQueue, mNetworkQueue, mCache, mDelivery);</span><br><span class="line">    mCacheDispatcher.start();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Create network dispatchers (and corresponding threads) up to the pool size.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mDispatchers.length; i++) &#123;</span><br><span class="line">        NetworkDispatcher networkDispatcher = <span class="keyword">new</span> NetworkDispatcher(mNetworkQueue, mNetwork,</span><br><span class="line">                mCache, mDelivery);</span><br><span class="line">        mDispatchers[i] = networkDispatcher;</span><br><span class="line">        networkDispatcher.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>可以看出来我们初始化了一个CacheDispatcher, 它是extends 线程的类, 它是一个可以对请求队列中cache 进行分类的线程.<br>也初始化了一个NetWorkDispatcher数组, NetWorkDispatcher 也是extends 线程的, 他是一个负责把从队列中取出来Request 并且执行的线程.<br>接下来当我们有Request 希望发出的时候, 我们就需要调用 RequestQueue的add方法了.<br>我们一句句的跟着add的方法进行分析,<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Request&lt;T&gt; <span class="title">add</span><span class="params">(Request&lt;T&gt; request)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 给这个request设置队列</span></span><br><span class="line">       request.setRequestQueue(<span class="keyword">this</span>); </span><br><span class="line">       <span class="comment">// 把这个request加入到一个HashSet中, 这个HashSet存着所有马上或者正在被任何dispacher处理中的request.</span></span><br><span class="line">       <span class="keyword">synchronized</span> (mCurrentRequests) &#123;</span><br><span class="line">           mCurrentRequests.add(request);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 给request 加上一些编号和marker</span></span><br><span class="line">       request.setSequence(getSequenceNumber());</span><br><span class="line">       request.addMarker(<span class="string">"add-to-queue"</span>);</span><br><span class="line">    </span><br><span class="line">       <span class="comment">// 如果当前这个request是不希望被缓存的, 那么他将直接被加入到NetworkQueue中去.</span></span><br><span class="line">       <span class="keyword">if</span> (!request.shouldCache()) &#123;</span><br><span class="line">           mNetworkQueue.add(request);</span><br><span class="line">           <span class="keyword">return</span> request;</span><br><span class="line">       &#125;</span><br><span class="line">    </span><br><span class="line">       <span class="keyword">synchronized</span> (mWaitingRequests) &#123;</span><br><span class="line">           <span class="comment">// 如果这个Request是希望被缓存的,会先检查下WaitingRequests里有没有该Reuqest.</span></span><br><span class="line">           String cacheKey = request.getCacheKey();</span><br><span class="line">           <span class="keyword">if</span> (mWaitingRequests.containsKey(cacheKey)) &#123;</span><br><span class="line">               Queue&lt;Request&lt;?&gt;&gt; stagedRequests = mWaitingRequests.get(cacheKey);</span><br><span class="line">               <span class="keyword">if</span> (stagedRequests == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   stagedRequests = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">               &#125;</span><br><span class="line">               stagedRequests.add(request);</span><br><span class="line">               mWaitingRequests.put(cacheKey, stagedRequests);</span><br><span class="line">               <span class="keyword">if</span> (VolleyLog.DEBUG) &#123;</span><br><span class="line">                   VolleyLog.v(<span class="string">"Request for cacheKey=%s is in flight, putting on hold."</span>, cacheKey);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               mWaitingRequests.put(cacheKey, <span class="keyword">null</span>);</span><br><span class="line">               <span class="comment">// 把该Request加入到mCacheQueue中.</span></span><br><span class="line">               mCacheQueue.add(request);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> request;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>我们先来看不需要缓存的Request 被加入到mNetworkQueue之后的流程, 之前我们说过,RequestQueue 会有几个NetworkDispatcher 工作线程在run, 我们来看下其中的run方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">           <span class="keyword">long</span> startTimeMs = SystemClock.elapsedRealtime();</span><br><span class="line">           Request&lt;?&gt; request;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">//  这里的mQueue 就是RequesQueue中的mNetworkQueue, request被加入到mNetworkQueue中以后,会被取出</span></span><br><span class="line">               request = mQueue.take();</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">               <span class="keyword">if</span> (mQuit) &#123;</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               request.addMarker(<span class="string">"network-queue-take"</span>);</span><br><span class="line">               <span class="keyword">if</span> (request.isCanceled()) &#123;</span><br><span class="line">                   request.finish(<span class="string">"network-discard-cancelled"</span>);</span><br><span class="line">                   <span class="keyword">continue</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               addTrafficStatsTag(request);</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 这里是执行request 请求的地方, 会返回一个NetworkResponse,这里的NetworkResponse是最基础的response raw数据.</span></span><br><span class="line">               NetworkResponse networkResponse = mNetwork.performRequest(request);</span><br><span class="line">               request.addMarker(<span class="string">"network-http-complete"</span>);</span><br><span class="line">    </span><br><span class="line">               <span class="keyword">if</span> (networkResponse.notModified &amp;&amp; request.hasHadResponseDelivered()) &#123;</span><br><span class="line">                   request.finish(<span class="string">"not-modified"</span>);</span><br><span class="line">                   <span class="keyword">continue</span>;</span><br><span class="line">               &#125;   </span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 对networkResponse进行解析,其中这里的泛型是Request设置的,由request自己根据自己的需要 对response中的data 字节数组进行解析.</span></span><br><span class="line">               Response&lt;?&gt; response = request.parseNetworkResponse(networkResponse);</span><br><span class="line">               request.addMarker(<span class="string">"network-parse-complete"</span>);</span><br><span class="line">    </span><br><span class="line">               <span class="comment">// 这里需要主要的是 如果这个request需要做缓存, 那么将被存入Cache中.</span></span><br><span class="line">               <span class="keyword">if</span> (request.shouldCache() &amp;&amp; response.cacheEntry != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   mCache.put(request.getCacheKey(), response.cacheEntry);</span><br><span class="line">                   request.addMarker(<span class="string">"network-cache-written"</span>);</span><br><span class="line">               &#125;</span><br><span class="line">    </span><br><span class="line">               <span class="comment">// 通过mDelivery返回 request 和 response. 注意这里是通过handler post到主线程的.</span></span><br><span class="line">               request.markDelivered();</span><br><span class="line">               mDelivery.postResponse(request, response);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (VolleyError volleyError) &#123;</span><br><span class="line">               volleyError.setNetworkTimeMs(SystemClock.elapsedRealtime() - startTimeMs);</span><br><span class="line">               parseAndDeliverNetworkError(request, volleyError);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               VolleyLog.e(e, <span class="string">"Unhandled exception %s"</span>, e.toString());</span><br><span class="line">               VolleyError volleyError = <span class="keyword">new</span> VolleyError(e);</span><br><span class="line">               volleyError.setNetworkTimeMs(SystemClock.elapsedRealtime() - startTimeMs);</span><br><span class="line">               mDelivery.postError(request, volleyError);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>至此一次完整的 无缓存 Http 请求就结束了.<br>接下来可以观察下 需要缓存的Request 和 不需要缓存的Request 处理区别, 不难发现 需要缓存的Request请求 会加入到mCacheQueue中去, 而会处理CacheQueue的Dispatcher 正是<br>刚才我们初始化的mCacheDispatcher, 我们来看看mCacheDispatcher的run方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) VolleyLog.v(<span class="string">"start new dispatcher"</span>);</span><br><span class="line">        Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">        mCache.initialize();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 这里从我们刚才加入request的CacheQueue取出 Request, 如果request 是空 会卡住该线程,直到有Request入列.</span></span><br><span class="line">                <span class="keyword">final</span> Request&lt;?&gt; request = mCacheQueue.take();</span><br><span class="line">                request.addMarker(<span class="string">"cache-queue-take"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (request.isCanceled()) &#123;</span><br><span class="line">                    request.finish(<span class="string">"cache-discard-canceled"</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 这里会去Cache中找该Request的缓存, 如果找不到就会把他加入到mNetworkQueue 去执行首次请求.</span></span><br><span class="line">                Cache.Entry entry = mCache.get(request.getCacheKey());</span><br><span class="line">                <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    request.addMarker(<span class="string">"cache-miss"</span>);</span><br><span class="line">                    mNetworkQueue.put(request);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果从缓存中查找到了这个Request的缓存, 但是它已经过期了,那么依旧会把他加入到mNetworkQueue 去再次执行请求.</span></span><br><span class="line">                <span class="keyword">if</span> (entry.isExpired()) &#123;</span><br><span class="line">                    request.addMarker(<span class="string">"cache-hit-expired"</span>);</span><br><span class="line">                    request.setCacheEntry(entry);</span><br><span class="line">                    mNetworkQueue.put(request);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 走到这说明我们拿到了这个Request的 有效缓存</span></span><br><span class="line">                request.addMarker(<span class="string">"cache-hit"</span>);</span><br><span class="line">                Response&lt;?&gt; response = request.parseNetworkResponse(</span><br><span class="line">                        <span class="keyword">new</span> NetworkResponse(entry.data, entry.responseHeaders));</span><br><span class="line">                request.addMarker(<span class="string">"cache-hit-parsed"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!entry.refreshNeeded()) &#123;</span><br><span class="line">                    <span class="comment">// 如果这个Request 不需要更新, 那么到此该Http请求就结束了, 依旧是通过mDelivery 返回Request和response.</span></span><br><span class="line">                    mDelivery.postResponse(request, response);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果需要更新该request, 那么会在返回request和response的同时,再次去请求该Request.</span></span><br><span class="line">                    request.addMarker(<span class="string">"cache-hit-refresh-needed"</span>);</span><br><span class="line">                    request.setCacheEntry(entry);</span><br><span class="line">                    response.intermediate = <span class="keyword">true</span>;</span><br><span class="line">                    mDelivery.postResponse(request, response, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                mNetworkQueue.put(request);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                                <span class="comment">// Not much we can do about this.</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mQuit) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>看到这里,Volley的大体框架 和工作流程就结束了,Volley这份代码虽然是三年前的框架,但是现在看依然是有很多可以学习的地方, 它的结构简单清晰, 可插拔性强, 层与层之间耦合低,都体现出了<br>它的水平.</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://saberpowermo.github.io/2017/09/14/volley/" data-id="cjszrxgv2000vu4kpgb29upkq" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="/2017/09/14/volley/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="/2017/09/14/volley/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-viewsavastate" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/05/01/viewsavastate/">正确的保存View状态.</a>
        </h1>
    

                <div class="article-meta">
                    
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/05/01/viewsavastate/">
            <time datetime="2017-05-01T02:31:30.000Z" itemprop="datePublished">2017-05-01</time>
        </a>
    </div>


                    
                    
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Android/">Android</a>
    </div>

                </div>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h5 id="纯手打原创-转载请注明出处-感谢"><a href="#纯手打原创-转载请注明出处-感谢" class="headerlink" title="纯手打原创,转载请注明出处,感谢!"></a>纯手打原创,转载请注明出处,感谢!</h5><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>android 的 View以及ViewGroup保存相应状态是一件很重要的事情,但是最近由于用到了相关的内容, 搜了下国内相关文章,涉及到的很少.<br>可能很多人都在开发的时候忽略掉了这个功能.自己看了下相应的源码以及翻阅了下相关的文章,了解了下相应的知识,于是写下这篇记录,算是给以后自己翻阅做个笔记.</p>
<p>首先我们要明白View 为什么要保存自己的状态? 我咨询了一些做android开发的朋友,给出的答案都是五花八门, 但大部分都是说不关心保存状态这件事, 当我说这样不对的时候,<br>往往得到的回复是我的代码一直好好的啊 没什么问题啊.<br>是的,代码如果不去关心View 保存状态这件事 在大部分时间都是没问题的,但是在一些情况下会出乱子.<br>我举个例子, 我们的Activity A 去Activity B, 这时候A会走 onPause onStop onSaveInstanceState() 的生命周期. 我们要先明白Activity给我们这个onSaveInstanceState()回调时机的意义,<br>来看一下源码的说明  </p>
<h5 id="Called-to-retrieve-per-instance-state-from-an-activity-before-being-killed-so-that-the-state-can-be-restored-in-link-onCreate-or-link-onRestoreInstanceState-the-link-Bundle-populated-by-this-method-will-be-passed-to-both-This-method-is-called-before-an-activity-may-be-killed-so-that-when-it-comes-back-some-time-in-the-future-it-can-restore-its-state-For-example-if-activity-B-is-launched-in-front-of-activity-A-and-at-some-point-activity-A-is-killed-to-reclaim-resources-activity-A-will-have-a-chance-to-save-the-current-state-of-its-user-interface-via-this-method-so-that-when-the-user-returns-to-activity-A-the-state-of-the-user-interface-can-be-restored-via-link-onCreate-or-link-onRestoreInstanceState"><a href="#Called-to-retrieve-per-instance-state-from-an-activity-before-being-killed-so-that-the-state-can-be-restored-in-link-onCreate-or-link-onRestoreInstanceState-the-link-Bundle-populated-by-this-method-will-be-passed-to-both-This-method-is-called-before-an-activity-may-be-killed-so-that-when-it-comes-back-some-time-in-the-future-it-can-restore-its-state-For-example-if-activity-B-is-launched-in-front-of-activity-A-and-at-some-point-activity-A-is-killed-to-reclaim-resources-activity-A-will-have-a-chance-to-save-the-current-state-of-its-user-interface-via-this-method-so-that-when-the-user-returns-to-activity-A-the-state-of-the-user-interface-can-be-restored-via-link-onCreate-or-link-onRestoreInstanceState" class="headerlink" title="Called to retrieve per-instance state from an activity before being killed so that the state can be restored in {@link #onCreate} or {@link #onRestoreInstanceState} (the {@link Bundle} populated by this method will be passed to both).  This method is called before an activity may be killed so that when it comes back some time in the future it can restore its state.  For example, if activity B is launched in front of activity A, and at some point activity A is killed to reclaim resources, activity A will have a chance to save the current state of its user interface via this method so that when the user returns to activity A, the state of the user interface can be restored via {@link #onCreate} or {@link #onRestoreInstanceState}."></a>Called to retrieve per-instance state from an activity before being killed so that the state can be restored in {@link #onCreate} or {@link #onRestoreInstanceState} (the {@link Bundle} populated by this method will be passed to both).  This method is called before an activity may be killed so that when it comes back some time in the future it can restore its state.  For example, if activity B is launched in front of activity A, and at some point activity A is killed to reclaim resources, activity A will have a chance to save the current state of its user interface via this method so that when the user returns to activity A, the state of the user interface can be restored via {@link #onCreate} or {@link #onRestoreInstanceState}.</h5><p>意思就是说 这个Activity在被杀死之前 给你一个机会让你保留你希望保存的东西, 而你保存的东西会在什么时候还给你呢, 会在onCreate 或者onRestoreState的时候.<br>之前有人跟我, 我完全可以不用care这个回调啊,我可以在Activity内自己创建一个Member变量容器 去保存我希望保存的内容啊, 这里是我们需要明白的一个关键,<br>那就是 Activity A 去Activity B, Activity A 如果不被系统杀死回收的话,那怎么搞都是没问题的,但是一旦因为内存不足,Activity A被回收掉,你想想,你的Member容器也会随之一起回收掉.<br>等你从Activity B back 回Activity A的时候, 就会丢失掉你所有希望保存的内容.<br>这里有一个小细节就是 会有人不知道怎么去测试 Activity A 去Activity B, 然后Activity A 被回收的情况, 我们的android手机内 开发者模式, 有一个选项叫 不保留活动.打开以后,<br>只要你退出当前的Activity(按home或者去别的Activity), 你当前的Activity 就必定会被系统杀死回收. 看到这里如果不了解这个选项的朋友可以去打开这个选项试试自己的app.或许你会发现打开了新大门..<br>还有一个小细节就是有可能打开这个开关以后你检查了下你的app 然后告诉我说并没有什么问题, 不会有崩溃啊什么的, 要注意,这里的问题是指 本来应该保存的一些内容 或者用户已经加载过 或者用户已经在当前页面做过的一些动作<br>没有被保存,这句话需要仔细去理解一下,然后再check下自己的app,看看是不是会有东西丢失.</p>
<h3 id="View-保存State的一些知识点"><a href="#View-保存State的一些知识点" class="headerlink" title="View 保存State的一些知识点"></a>View 保存State的一些知识点</h3><p>View saveState 与 restoreState 两套动作都是相对应的, 分别有这么几个关键的方法.</p>
<h5 id="saveState"><a href="#saveState" class="headerlink" title="saveState."></a>saveState.</h5><ul>
<li>void saveHierarchyState(SparseArray<parcelable> container)<br>这个方法是android framework层调用,在需要保存状态的时机. 看下View源码发现通常是不做什么事情的.是直接调用dispatchSaveInstanceState的</parcelable></li>
<li>void dispatchSaveInstanceState(SparseArray<parcelable> container)<br>这个方法是被saveHierarchyState调用,它内部会调用onSaveInstanceState 方法去拿到一个存储View当前状态的Parcelable对象, 然后存在container中.这里有两个个关键点<br>1 它的第一句就是 if(mId != NO_ID) 才会执行接下来的保存状态的工作,也就是说如果我们的View希望保存状态那么一定要有一个ID,其实这很好理解, 保存着我们View状态的parcelable 是以key value的形式<br>保存在container中的,那么key是我们的id 也是合情合理的.<br>代码如下 非常清晰<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchSaveInstanceState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mID != NO_ID &amp;&amp; (mViewFlags &amp; SAVE_DISABLED_MASK) == <span class="number">0</span>) &#123;</span><br><span class="line">        mPrivateFlags &amp;= ~PFLAG_SAVE_STATE_CALLED;</span><br><span class="line">        Parcelable state = onSaveInstanceState();</span><br><span class="line">        <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_SAVE_STATE_CALLED) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    <span class="string">"Derived class did not call super.onSaveInstanceState()"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (state != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Log.i("View", "Freezing #" + Integer.toHexString(mID)</span></span><br><span class="line">            <span class="comment">// + ": " + state);</span></span><br><span class="line">            container.put(mID, state);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</parcelable></li>
</ul>
<p>2 如果当前View是一个ViewGroup那么它会去循环调用每个child的dispatchSaveInstanceState(), 去给child机会保存状态, android这样设计的地方很多, 比如Touch分发 比如 Measure分发等等,这里就不过多表述了.<br>代码如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchSaveInstanceState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.dispatchSaveInstanceState(container);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = mChildrenCount;</span><br><span class="line">    <span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        View c = children[i];</span><br><span class="line">        <span class="keyword">if</span> ((c.mViewFlags &amp; PARENT_SAVE_DISABLED_MASK) != PARENT_SAVE_DISABLED) &#123;</span><br><span class="line">            c.dispatchSaveInstanceState(container);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>Parcelable onSaveInstanceState()<br>这个方法就很简单了, 是真正干活的地方,保存当前View的状态, 我们写自定义View的时候 也往往是重写该方法去保存我们需要保存的状态.  </li>
</ul>
<h5 id="restoreState"><a href="#restoreState" class="headerlink" title="restoreState."></a>restoreState.</h5><ul>
<li>void restoreHierarchyState(SparseArray<parcelable> container)<br>对应saveHierarchyState()</parcelable></li>
<li>void dispatchRestoreInstanceState(SparseArray<parcelable> container)<br>对应dispatchSaveInstanceState()</parcelable></li>
<li>void onRestoreInstanceState(Parcelable state)<br>对应onSaveInstanceState()</li>
</ul>
<p>还有一个方法是需要特殊说明的, 如果你的自定义View需要保存状态, 那么你需要调用setSaveEnabled(true)方法. 当然widgets官方提供的view都是打开了的.你不用操心.<br>看到这里大家应该以及知道了View保存恢复状态的整个流程是什么样的了,一个View 如果想要保存状态,那么只需要做两件事</p>
<ol>
<li>有id  </li>
<li>setSaveEnabled(true)</li>
</ol>
<h3 id="如何保存自己的状态"><a href="#如何保存自己的状态" class="headerlink" title="如何保存自己的状态"></a>如何保存自己的状态</h3><p>我们已经知道了我们自定义View应该在onSaveInstanceState的时候去保存我们希望保存的状态,那么具体应该怎么去做呢.接下来是示范(炒鸡简单)<br>比如我们的View内有1个int值希望保存下来, 那么我们的代码应该这样写,<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> mState;</span><br><span class="line">...</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Parcelable <span class="title">onSaveInstanceState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Parcelable superState = <span class="keyword">super</span>.onSaveInstanceState();</span><br><span class="line">        SavedState ss = <span class="keyword">new</span> SavedState(superState);  </span><br><span class="line">        ss.state = customState;  </span><br><span class="line">        <span class="keyword">return</span> ss;  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRestoreInstanceState</span><span class="params">(Parcelable state)</span> </span>&#123;</span><br><span class="line">        SavedState ss = (SavedState) state;</span><br><span class="line">        <span class="keyword">super</span>.onRestoreInstanceState(ss.getSuperState());  </span><br><span class="line">        setCustomState(ss.state);  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SavedState</span> <span class="keyword">extends</span> <span class="title">BaseSavedState</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> state;</span><br><span class="line"></span><br><span class="line">        SavedState(Parcelable superState) &#123;  </span><br><span class="line">            <span class="keyword">super</span>(superState);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">SavedState</span><span class="params">(Parcel in)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(in);</span><br><span class="line">            state = in.readInt();  </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel out, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.writeToParcel(out, flags);</span><br><span class="line">            out.writeInt(state);  </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Parcelable.Creator&lt;SavedState&gt; CREATOR</span><br><span class="line">                = <span class="keyword">new</span> Parcelable.Creator&lt;SavedState&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> SavedState <span class="title">createFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> SavedState(in);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> SavedState[] newArray(<span class="keyword">int</span> size) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> SavedState[size];</span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="一个经验教训"><a href="#一个经验教训" class="headerlink" title="一个经验教训."></a>一个经验教训.</h3><p>当我们做一个View的时候,那么上面的内容足够让你保存你想要保存的状态. 但是如果是一个ViewGroup的话, 代码或许在某些情况下应该这样去设计,<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Parcelable <span class="title">onSaveInstanceState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       Parcelable superState = <span class="keyword">super</span>.onSaveInstanceState();</span><br><span class="line">       SavedState ss = <span class="keyword">new</span> SavedState(superState);  </span><br><span class="line">       ss.childrenStates = <span class="keyword">new</span> SparseArray();  </span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; getChildCount(); i++) &#123;  </span><br><span class="line">           getChildAt(i).saveHierarchyState(ss.childrenStates);</span><br><span class="line">       &#125;  </span><br><span class="line">       <span class="keyword">return</span> ss;</span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRestoreInstanceState</span><span class="params">(Parcelable state)</span> </span>&#123;</span><br><span class="line">       SavedState ss = (SavedState) state;</span><br><span class="line">       <span class="keyword">super</span>.onRestoreInstanceState(ss.getSuperState());  </span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; getChildCount(); i++) &#123;  </span><br><span class="line">           getChildAt(i).restoreHierarchyState(ss.childrenStates);</span><br><span class="line">       &#125;  </span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchSaveInstanceState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> </span>&#123;</span><br><span class="line">       dispatchFreezeSelfOnly(container);</span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchRestoreInstanceState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> </span>&#123;</span><br><span class="line">       dispatchThawSelfOnly(container);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>你需要去注意一下在 dispatchSaveInstanceState 和 dispatchRestoreInstanceState,我们并不是使用super方法 去遍历我们的children去挨个保存和恢复状态,而是<br>调用dispatchFreezeSelfOnly 和 dispatchThawSelfOnly 来告诉系统,我这个ViewGroup不需要去挨个找我的child去保存状态,我们(ViewGroup)自己来就可以了.<br>当然并不是说,如果我们写ViewGroup的时候就一定要这样去写,具体情况要根据自己的实际情况去决定.</p>
<h3 id="另外一个血和泪的经验教训"><a href="#另外一个血和泪的经验教训" class="headerlink" title="另外一个血和泪的经验教训."></a>另外一个血和泪的经验教训.</h3><p>在上面的例子中, 我们的SavedState 存储了一个int值, 这属于比较简单的一种实现,一般是不会有什么问题的,如果你需要存储的内容是一个Bundle的时候,你往往会这样写;<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SavedState</span> <span class="keyword">extends</span> <span class="title">BaseSavedState</span> </span>&#123;</span><br><span class="line">           Bundle state;</span><br><span class="line">   </span><br><span class="line">           SavedState(Parcelable superState) &#123;  </span><br><span class="line">               <span class="keyword">super</span>(superState);</span><br><span class="line">           &#125;</span><br><span class="line">   </span><br><span class="line">           <span class="function"><span class="keyword">private</span> <span class="title">SavedState</span><span class="params">(Parcel in)</span> </span>&#123;</span><br><span class="line">               <span class="keyword">super</span>(in);</span><br><span class="line">               state = in.readBundle(Bundle.class.getClassLoader());</span><br><span class="line">           &#125;</span><br><span class="line">   </span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel out, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">               <span class="keyword">super</span>.writeToParcel(out, flags);</span><br><span class="line">               out.writeBundle(state);  </span><br><span class="line">           &#125;</span><br><span class="line">   </span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Parcelable.Creator&lt;SavedState&gt; CREATOR</span><br><span class="line">                   = <span class="keyword">new</span> Parcelable.Creator&lt;SavedState&gt;() &#123;</span><br><span class="line">               <span class="function"><span class="keyword">public</span> SavedState <span class="title">createFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">new</span> SavedState(in);</span><br><span class="line">               &#125;</span><br><span class="line">   </span><br><span class="line">               <span class="keyword">public</span> SavedState[] newArray(<span class="keyword">int</span> size) &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">new</span> SavedState[size];</span><br><span class="line">               &#125;  </span><br><span class="line">           &#125;;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></p>
<p>请注意,这些代码是系统自己生成的, 在大多数情况这样写依然是没有问题的, 但是 一旦你的Bundle里存储了一个你自定义的Parcelable类的时候,事情就会变的蛋疼起来,在你这个Bundle进行unparcel()的时候,会崩溃, 爆出BadParcelableException, 原因是 找不到你的自定义的那个类. 这个bug卡了我好长时间,<br>最后定位到了这个异常,爆出位置 : 首先你可以在Parcel类中的readValue(ClassLoader loader) 中找到readParcelable() 然后跟进去最后发现 会执行这么一段代码.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If loader == null, explicitly emulate Class.forName(String) "caller</span></span><br><span class="line">                   <span class="comment">// classloader" behavior.</span></span><br><span class="line">ClassLoader parcelableClassLoader =(loader == <span class="keyword">null</span> ? getClass().getClassLoader() : loader);</span><br></pre></td></tr></table></figure></p>
<p>第一次看到这个代码的时候,并没有注意什么. 后来查了很多stackoverflow,开始怀疑跟这个ClassLoader有关系.然后开始相应查相关的内容,最终找到了问题所在, 直接上结论把.</p>
<p>Android has two different classloaders: the framework classloader (which knows how to load Android classes) and the APK classloader (which knows how to load your code).<br>The APK classloader has the framework classloader set as its parent, meaning it can also load Android classes.</p>
<p>说的很清晰了, 就是ClassLoader找错了, 解决方案也很简单,<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">SavedState</span><span class="params">(Parcel in)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(in);</span><br><span class="line">        state = in.readBundle(getClass().getClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样写就会给Bundle 设置一个APK的ClassLoader, 这样就可以找到你自己定义的那个Parcelable类了.</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://saberpowermo.github.io/2017/05/01/viewsavastate/" data-id="cjszrxguz000qu4kpix1nbef0" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="/2017/05/01/viewsavastate/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="/2017/05/01/viewsavastate/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-downloadbug" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/03/17/downloadbug/">android 源生DownloadManager 的两个Crash 坑</a>
        </h1>
    

                <div class="article-meta">
                    
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/03/17/downloadbug/">
            <time datetime="2017-03-17T01:31:30.000Z" itemprop="datePublished">2017-03-17</time>
        </a>
    </div>


                    
                    
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Android/">Android</a>
    </div>

                </div>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>如果你的APP使用源生DownloadManager去更新apk,那么下面这3行代码你肯定不陌生,<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DownloadManager.Request request = <span class="keyword">new</span> DownloadManager.Request(Uri.parse(你的APK下载地址));</span><br><span class="line">request.setDestinationUri(你的app 本地存储URI));</span><br><span class="line"><span class="keyword">long</span> mDownloadId = mDownloadManager.enqueue(request);</span><br></pre></td></tr></table></figure></p>
<h3 id="IllegalArgumentException"><a href="#IllegalArgumentException" class="headerlink" title="IllegalArgumentException"></a>IllegalArgumentException</h3><p>这三行代码 最近在一些机型上爆出了java.lang.IllegalArgumentException: UnknownURLcontent://downloads/my_downloads 异常.<br>是崩溃在了mDownloadManager.enqueue(request)这里,<br>跟着代码进去以后<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">enqueue</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">    ContentValues values = request.toContentValues(mPackageName);</span><br><span class="line">    Uri downloadUri = mResolver.insert(Downloads.Impl.CONTENT_URI, values);</span><br><span class="line">    <span class="keyword">long</span> id = Long.parseLong(downloadUri.getLastPathSegment());</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续跟进,找到了崩溃的源头, 是 mResolver.insert这句的问题<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="meta">@Nullable</span> <span class="function">Uri <span class="title">insert</span><span class="params">(@NonNull Uri url, @Nullable ContentValues values)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(url, <span class="string">"url"</span>);</span><br><span class="line">    IContentProvider provider = acquireProvider(url);</span><br><span class="line">    <span class="keyword">if</span> (provider == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 看这里 嘿嘿嘿</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown URL "</span> + url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line">        Uri createdRow = provider.insert(mPackageName, url, values);</span><br><span class="line">        <span class="keyword">long</span> durationMillis = SystemClock.uptimeMillis() - startTime;</span><br><span class="line">        maybeLogUpdateToEventLog(durationMillis, url, <span class="string">"insert"</span>, <span class="keyword">null</span> <span class="comment">/* where */</span>);</span><br><span class="line">        <span class="keyword">return</span> createdRow;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="comment">// Arbitrary and not worth documenting, as Activity</span></span><br><span class="line">        <span class="comment">// Manager will kill this process shortly anyway.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        releaseProvider(provider);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>原因是系统的DownloadManager Service被关闭了, 遇见这种问题, 可以有两种解决方法<br>1 是通过产品角度去告知用户,让用户去系统里找到相应的开关 打开下载服务,<br>2 是catch 住这个IllegalArgumentException 然后不再使用downloadmanager 而是自己去手写下载, 就可以解决.</p>
<h3 id="SecurityException"><a href="#SecurityException" class="headerlink" title="SecurityException"></a>SecurityException</h3><p>这三行代码在某些机器上会爆出SecurityException，原因是Context.getExternalFilesDir得到的地址 和Environment.getExternalStorageDirectory() 不一致.<br>具体崩溃代码可以去看<a href="https://android.googlesource.com/platform/packages/providers/DownloadProvider/+/android-4.3.1_r1/src/com/android/providers/downloads/DownloadProvider.java" target="_blank" rel="noopener">源码</a> 的713行.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkFileUriDestination</span><span class="params">(ContentValues values)</span> </span>&#123;</span><br><span class="line">    String fileUri = values.getAsString(Downloads.Impl.COLUMN_FILE_NAME_HINT);</span><br><span class="line">    <span class="keyword">if</span> (fileUri == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                <span class="string">"DESTINATION_FILE_URI must include a file URI under COLUMN_FILE_NAME_HINT"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Uri uri = Uri.parse(fileUri);</span><br><span class="line">    String scheme = uri.getScheme();</span><br><span class="line">    <span class="keyword">if</span> (scheme == <span class="keyword">null</span> || !scheme.equals(<span class="string">"file"</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Not a file URI: "</span> + uri);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> String path = uri.getPath();</span><br><span class="line">    <span class="keyword">if</span> (path == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid file URI: "</span> + uri);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> String canonicalPath = <span class="keyword">new</span> File(path).getCanonicalPath();</span><br><span class="line">        <span class="keyword">final</span> String externalPath = Environment.getExternalStorageDirectory().getAbsolutePath();</span><br><span class="line">        <span class="keyword">if</span> (!canonicalPath.startsWith(externalPath)) &#123;</span><br><span class="line">            <span class="comment">// 看这里,嘿嘿嘿</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Destination must be on external storage: "</span> + uri);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Problem resolving path: "</span> + uri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>出现这种bug 我们的解决方案 是自己去拼1个存储地址..<br>所以这三行代码的最终使用是这样的:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DownloadManager.Request request = <span class="keyword">new</span> DownloadManager.Request(Uri.parse(你的APK下载地址));</span><br><span class="line">request.setDestinationUri(你的app 本地存储URI));</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> mDownloadId = instance.mSystemDownloadManager.enqueue(request);</span><br><span class="line"> &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">        File f = Environment.getExternalStorageDirectory();</span><br><span class="line">        f = <span class="keyword">new</span> File(f, <span class="string">"Android"</span>);</span><br><span class="line">        f = <span class="keyword">new</span> File(f, <span class="string">"data"</span>);</span><br><span class="line">        f = <span class="keyword">new</span> File(f, mContext.getPackageName());</span><br><span class="line">        f = <span class="keyword">new</span> File(f, <span class="string">"files"</span>);</span><br><span class="line">        f = <span class="keyword">new</span> File(f, Environment.DIRECTORY_DOWNLOADS);</span><br><span class="line">        <span class="keyword">if</span> (!f.exists()) &#123;</span><br><span class="line">            f.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">        request.setDestinationUri(f));</span><br><span class="line">        instance.mDownloadId = instance.mSystemDownloadManager.enqueue(request);</span><br><span class="line"> &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">     <span class="comment">// 自己去写把 要么弹toast告诉用户他傻逼, 要么自己去手写下载</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://saberpowermo.github.io/2017/03/17/downloadbug/" data-id="cjszrxgu50000u4kp4xe04nwr" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="/2017/03/17/downloadbug/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="/2017/03/17/downloadbug/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-video_codec" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/02/24/video_codec/">音视频编码基础技术.</a>
        </h1>
    

                <div class="article-meta">
                    
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/02/24/video_codec/">
            <time datetime="2017-02-24T14:31:30.000Z" itemprop="datePublished">2017-02-24</time>
        </a>
    </div>


                    
                    
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Android/">Android</a>
    </div>

                </div>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>本文参考文章:<br><a href="https://en.wikipedia.org/wiki/Comparison_of_streaming_media_systems" target="_blank" rel="noopener">流媒体系统对比</a><br><a href="https://en.wikipedia.org/wiki/Comparison_of_container_formats" target="_blank" rel="noopener">封装格式对比</a><br><a href="https://en.wikipedia.org/wiki/Comparison_of_video_codecs" target="_blank" rel="noopener">视频编码器对比</a><br><a href="https://en.wikipedia.org/wiki/Comparison_of_audio_coding_formats" target="_blank" rel="noopener">音频编码格式对比</a><br><a href="http://blog.csdn.net/leixiaohua1020" target="_blank" rel="noopener">雷霄骅雷神博客</a><br><a href="http://hevc.info/" target="_blank" rel="noopener">HEVC</a><br><a href="http://x265.org/" target="_blank" rel="noopener">x265编码器</a></p>
<p>我们平时下载的电影,因为下载的来源不同，这些电影文件有不同的格式，用不同的后缀表示：avi，rmvb，mp4，flv，mkv等等（当然也使用不同的图标）。在这里需要注意的是，这些格式代表的是封装格式。何为封装格式？就是把视频数据和音频数据打包成一个文件的规范。仅仅靠看文件的后缀，很难能看出具体使用了什么视音频编码标准。总的来说，不同的封装格式之间差距不大，各有优劣。<br>注：有些封装格式支持的视音频编码标准十分广泛，应该算比较优秀的封装格式，比如MKV；而有些封装格式支持的视音频编码标准很少，应该属于落后的封装格式，比如RMVB。<br>在此我选用了魔力盒中的一个视频 进行说明.<br>该视频的 后缀为 mp4.  Video codec_name 为H.264, Audio codec_name 为 aac.<br>这样我们就可以说 这个视频 采用mp4的QuickTime封装格式（MOV），采用了H.264（AVC）的视频压缩编码标准, AAC的音频编码标准.</p>
<p>接下来说一下我们使用播放器去播放一个视频, 中间发生了什么.<br>视频播放器播放一个互联网上的视频文件，需要经过以下几个步骤：解协议，解封装，解码视音频，视音频同步。<br>如果播放本地文件则不需要解协议，为以下几个步骤：解封装，解码视音频，视音频同步。<br>他们的过程如图所示。<br><img src="/images/image2017-2-24_14-5-19.png" alt="过程图"></p>
<p>其中<br>解协议的作用，就是将流媒体协议的数据，解析为标准的相应的封装格式数据。视音频在网络上传播的时候，常常采用各种流媒体协议，例如HTTP，RTMP，或是MMS等等。这些协议在传输视音频数据的同时，也会传输一些信令数据。这些信令数据包括对播放的控制（播放，暂停，停止），或者对网络状态的描述等。解协议的过程中会去除掉信令数据而只保留视音频数据。例如，采用RTMP协议传输的数据，经过解协议操作后，输出FLV格式的数据。<br>解封装的作用，就是将输入的封装格式的数据，分离成为音频流压缩编码数据和视频流压缩编码数据。封装格式种类很多，例如MP4，MKV，RMVB，TS，FLV，AVI等等，它的作用就是将已经压缩编码的视频数据和音频数据按照一定的格式放到一起。例如，FLV格式的数据，经过解封装操作后，输出H.264编码的视频码流和AAC编码的音频码流。<br>解码的作用，就是将视频/音频压缩编码数据，解码成为非压缩的视频/音频原始数据。音频的压缩编码标准包含AAC，MP3，AC-3等等，视频的压缩编码标准则包含H.264，MPEG2，VC-1等等。解码是整个系统中最重要也是最复杂的一个环节。通过解码，压缩编码的视频数据输出成为非压缩的颜色数据，例如YUV420P，RGB等等；压缩编码的音频数据输出成为非压缩的音频抽样数据，例如PCM数据。<br>视音频同步的作用，就是根据解封装模块处理过程中获取到的参数信息，同步解码出来的视频和音频数据，并将视频音频数据送至系统的显卡和声卡播放出来</p>
<p>其中几个概念的 特殊说明</p>
<h3 id="流媒体协议"><a href="#流媒体协议" class="headerlink" title="流媒体协议"></a>流媒体协议</h3><p>流媒体协议是服务器与客户端之间通信遵循的规定。当前网络上主要的流媒体协议如表所示。</p>
<h4 id="主要流媒体协议一览"><a href="#主要流媒体协议一览" class="headerlink" title="主要流媒体协议一览"></a>主要流媒体协议一览</h4><p><img src="/images/liumeiti.png" alt="流媒体"></p>
<h3 id="封装格式"><a href="#封装格式" class="headerlink" title="封装格式"></a>封装格式</h3><p>封装格式的主要作用是把视频码流和音频码流按照一定的格式存储在一个文件中。现如今流行的封装格式如下表所示：</p>
<h4 id="主要封装格式一览"><a href="#主要封装格式一览" class="headerlink" title="主要封装格式一览"></a>主要封装格式一览</h4><p><img src="/images/fengzhuanggeshi.png" alt="封装格式"></p>
<h3 id="视频编码"><a href="#视频编码" class="headerlink" title="视频编码"></a>视频编码</h3><p>视频编码的主要作用是将视频像素数据（RGB，YUV等）压缩成为视频码流，从而降低视频的数据量。如果视频不经过压缩编码的话，体积通常是非常大的，一部电影可能就要上百G的空间。视频编码是视音频技术中最重要的技术之一。视频码流的数据量占了视音频总数据量的绝大部分。高效率的视频编码在同等的码率下，可以获得更高的视频质量。</p>
<h4 id="主要视频编码一览"><a href="#主要视频编码一览" class="headerlink" title="主要视频编码一览"></a>主要视频编码一览</h4><p><img src="/images/shipinbianma.png" alt="视频编码"><br>由表可见，有两种视频编码方案是最新推出的：VP9和HEVC。目前这两种方案都处于研发阶段，还没有到达实用的程度。当前使用最多的视频编码方案就是H.264。</p>
<h3 id="音频编码"><a href="#音频编码" class="headerlink" title="音频编码"></a>音频编码</h3><p>音频编码的主要作用是将音频采样数据（PCM等）压缩成为音频码流，从而降低音频的数据量。音频编码也是互联网视音频技术中一个重要的技术。但是一般情况下音频的数据量要远小于视频的数据量，因而即使使用稍微落后的音频编码标准，而导致音频数据量有所增加，也不会对视音频的总数据量产生太大的影响。高效率的音频编码在同等的码率下，可以获得更高的音质。</p>
<h4 id="主要音频编码一览"><a href="#主要音频编码一览" class="headerlink" title="主要音频编码一览"></a>主要音频编码一览</h4><p><img src="/images/yinpinbianma.png" alt="音频编码"><br>由表可见，近年来并未推出全新的音频编码方案，可见音频编码技术已经基本可以满足人们的需要。音频编码技术近期绝大部分的改动都是在MP3的继任者——AAC的基础上完成的。</p>
<h3 id="现有网络视音频平台对比"><a href="#现有网络视音频平台对比" class="headerlink" title="现有网络视音频平台对比"></a>现有网络视音频平台对比</h3><p>现有的网络视音频服务主要包括两种方式：点播和直播。点播意即根据用户的需要播放相应的视频节目，这是互联网视音频服务最主要的方式。绝大部分视频网站都提供了点播服务。直播意即互联网视音频平台直接将视频内容实时发送给用户，目前还处于发展阶段。直播在网络电视台，社交视频网站较为常见。</p>
<h4 id="直播平台参数对比"><a href="#直播平台参数对比" class="headerlink" title="直播平台参数对比"></a>直播平台参数对比</h4><p>主流互联网视音频平台直播服务的参数对比如表所示：<br>                        现有网络视音频平台参数对比<br><img src="/images/zhibopintai.png" alt="zhibo"></p>
<p>可以看出，直播服务普遍采用了RTMP作为流媒体协议，FLV作为封装格式，H.264作为视频编码格式，AAC作为音频编码格式。采用RTMP作为直播协议的好处在于其被Flash播放器支持。而Flash播放器如今已经安装在全球99%的电脑上，并且与浏览器结合的很好。因此这种流媒体直播平台可以实现“无插件直播”，极大的简化了客户端的操作。封装格式，视频编码，音频编码方面，无一例外的使用了FLV + H.264 + AAC的组合。FLV是RTMP使用的封装格式，H.264是当今实际应用中编码效率最高的视频编码标准，AAC则是当今实际应用中编码效率最高的音频编码标准。视频播放器方面，都使用了Flash播放器。</p>
<h4 id="点播平台参数对比"><a href="#点播平台参数对比" class="headerlink" title="点播平台参数对比"></a>点播平台参数对比</h4><p>主流网络视音频平台点播服务的参数对比如表所示：<br>                        现有互联网视音频平台参数对比<br><img src="/images/zhibopintai.png" alt="dianbo"><br>可以看出，点播服务普遍采用了HTTP作为流媒体协议，H.264作为视频编码格式，AAC作为音频编码格式。采用HTTP作为点播协议有以下两点优势：一方面，HTTP是基于TCP协议的应用层协议，媒体传输过程中不会出现丢包等现象，从而保证了视频的质量；另一方面，HTTP被绝大部分的Web服务器支持，因而流媒体服务机构不必投资购买额外的流媒体服务器，从而节约了开支。点播服务采用的封装格式有多种：MP4，FLV，F4V等，它们之间的区别不是很大。视频编码标准和音频编码标准是H.264和AAC。这两种标准分别是当今实际应用中编码效率最高的视频标准和音频标准。视频播放器方面，无一例外的都使用了Flash播放器。</p>
<h2 id="H-265"><a href="#H-265" class="headerlink" title="H.265."></a>H.265.</h2><p>首先可以明确的是 H265 属于一种视频编码格式, 这里有一篇比较专业的说明, HEVC / H.265 Explained<br><img src="/images/h265.png" alt="h265"></p>
<p>说到H.265, 就不得不先提一下H.264了, H.264仅仅是一个编码标准，而不是一个具体的编码器，H.264只是给编码器的实现提供参照用的。<br>Google推出的VP8属于和H.264同一时代的标准。总体而言，VP8比H.264要稍微差一点。除了在技术领域，VP8和H.264在专利等方面也是打的不可开交。<br>可以武断的说,H264.是现在最主流的视频编码标准.<br>而H.265 是 H.264/MPEG-4 AVC的继任者。目前正在由ISO/IEC MPEG和ITU-T VCEG开发中。为此目的MPEG与VCEG联合成立了一个JCT-VC（JointCollaborative Team on Video Coding）作为共同开发HEVC的团队。HEVC被认为不仅提升图像质量，同时也能达到H.264/MPEG-4 AVC两倍之压缩率（等同于同样画面质量下比特率减少了50%），可支持4K分辨率甚至到超高画质电视，最高分辨率可达到8192×4320（8K分辨率）。第一版的HEVC/H.265视频压缩标准在2013年4月13日被接受为国际电信联盟（ITU-T）的正式标准。<br>VP9是一个由Google开发的开放的视频压缩标准。VP9将是VP8的后继者。VP9的开发始于2011。VP9的目标之一是相同质量下相对于VP8可以减少50%的比特率。而另一个目标就是争取能在压缩效率上高于HEVC。2013年2月21日，第一个支持VP9解码技术的Google Chrome网页浏览器发布了。<br>HEVC VP9 以及x264的性能对比, 结果参考 Dan Grois等人的论文《Performance Comparison of H.265/MPEG-HEVC, VP9, andH.264/MPEG-AVC Encoders》 </p>
<p>选用的编码器如下：</p>
<p>HEVC：HM<br>VP9：libvpx<br>H.264：x264</p>
<p>HEVC性能最强，奇怪的是x264的性能竟然好于VP9。要知道VP9可是Google推出的下一代编码标准。x264太强悍了！</p>
<p>PS：此外，x264的速度是远远高于HEVC和VP9的。</p>
<p><img src="/images/duibi1.jpeg" alt="对比1"></p>
<p>下表显示了HEVC在同等质量的前提下（以PSNR为依据），相对于VP9和x264节约的码率。下表显示了所有序列的情况。总体来说HEVC相对于VP9节约了41.9%，HEVC相对于x264节约了38.9%。</p>
<p><img src="/images/duibi2.jpeg" alt="对比2"></p>
<p>下表显示了三种编码器整体性能的比较。表中百分比数字的意义是：同等视频质量的前提下，该列所属的编码器相对于该行所属的编码器节约的码率，如果为负值，则代表反而消耗了更多的码率。例如，同等质量的前提下，x264相对于VP9节约了8.4%的码率。</p>
<p><img src="/images/duibi3.jpeg" alt="对比3"></p>
<p>同等视频质量的前提条件下，编码消耗时间对比如下表所示。可以看出，VP9编码时间大约是x264的130倍。HEVC编码时间大约是VP9的7倍。</p>
<p><img src="/images/duibi4.jpeg" alt="对比4"></p>
<p>此外，在码率一定的情况下，几种编码标准结果大致是这样的：HEVC &gt; VP9 &gt; H.264&gt; VP8 &gt; MPEG4 &gt; H.263 &gt; MPEG2。</p>
<p>HEVC 在未来拥有很大的优势, 具体可以参考以下文字段</p>
<p>在数字视频应用产业链的快速发展中，面对视频应用不断向高清晰度、高帧率、高压缩率方向发展的趋势，当前主流的视频压缩标准协议H.264(AVC)的局限性不断凸显。同时，面向更高清晰度、更高帧率、更高压缩率视频应用的HEVC(H.265)协议标准应运而生。本文重点分析了下一代视频压缩协议标准HEVC(H.265)的技术亮点，并对其在未来应用中将给整个产业带来的深刻变化予以展望。</p>
<p>H.264(AVC)从2003年5月草稿发布以来，凭借其相对于以往的视频压缩标准在压缩效率以及网络适应性方面的明显优势，逐步成为视频应用领域的主流标准。根据 MeFeedia的数据，由于iPad以及其它新兴设备大多支持H.264硬件加速，至2011年底，80%的视频使用H.264编码，并且随着支持H.264解码的设备不断增多，这一占有率还将进一步增长。</p>
<p>　　但是，随着数字视频应用产业链的快速发展，视频应用向以下几个方向发展的趋势愈加明显：</p>
<p>(1) 高清晰度(HigherDefinition)：数字视频的应用格式从720 P向1080 P全面升级，在一些视频应用领域甚至出现了4K x 2K、8K x 4K的数字视频格式;</p>
<p>(2) 高帧率(Higherframe rate )：数字视频帧率从30fps向60fps、120fps甚至240fps的应用场景升级;</p>
<p>(3) 高压缩率(HigherCompression rate )：传输带宽和存储空间一直是视频应用中最为关键的资源，因此，在有限的空间和管道中获得最佳的视频体验一直是用户的不懈追求。</p>
<p>　　由于数字视频应用在发展中面临上述趋势，如果继续采用H.264编码就出现的如下一些局限性：</p>
<p>(1) 宏块个数的爆发式增长，会导致用于编码宏块的预测模式、运动矢量、参考帧索引和量化级等宏块级参数信息所占用的码字过多，用于编码残差部分的码字明显减少。</p>
<p>(2) 由于分辨率的大大增加，单个宏块所表示的图像内容的信息大大减少，这将导致相邻的4 x 4或8 x 8块变换后的低频系数相似程度也大大提高，导致出现大量的冗余。</p>
<p>(3) 由于分辨率的大大增加，表示同一个运动的运动矢量的幅值将大大增加，H.264中采用一个运动矢量预测值，对运动矢量差编码使用的是哥伦布指数编码，该编码方式的特点是数值越小使用的比特数越少。因此，随着运动矢量幅值的大幅增加，H.264中用来对运动矢量进行预测以及编码的方法压缩率将逐渐降低。</p>
<p>(4) H.264的一些关键算法例如采用CAVLC和CABAC两种基于上下文的熵编码方法、deblock滤波等都要求串行编码，并行度比较低。针对GPU/DSP/FPGA/ASIC等并行化程度非常高的CPU，H.264的这种串行化处理越来越成为制约运算性能的瓶颈。</p>
<p>　　为了面对以上发展趋势，2010年1月，ITU-T VCEG(VideoCoding Experts Group) 和ISO/IEC MPEG(Moving Picture Experts Group)联合成立JCT-VC(JointCollaborative Team on Video Coding)了联合组织，统一制定下一代编码标准：HEVC(High Efficiency Video Coding)。<br>HEVC协议标准计划于2013年2月份正式在业界发布，目前整个框架结构已基本确定。截至2012年4月份，JCT-VC联合工作组已经召开了第八次会议，并于2012年2月17日发布了第一版内部草稿《High efficiency videocoding (HEVC) text specification draft 6》，计划2012年7月发布第一版公开版草稿，在H.264标准2～4倍的复杂度基础上，将压缩效率提升一倍以上。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://saberpowermo.github.io/2017/02/24/video_codec/" data-id="cjszrxguw000lu4kp59dmox6o" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="/2017/02/24/video_codec/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="/2017/02/24/video_codec/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-webview" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/02/16/webview/">WebView开发小记.</a>
        </h1>
    

                <div class="article-meta">
                    
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/02/16/webview/">
            <time datetime="2017-02-16T09:31:30.000Z" itemprop="datePublished">2017-02-16</time>
        </a>
    </div>


                    
                    
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Android/">Android</a>
    </div>

                </div>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>最近重构了公司的播放器模块,重新整理了整套代码,并且加入了StateMachine, 然后现在处于提测阶段, 打算在提测确认无bug之后进行一次StateMachine使用的总结,在这个任务空档期,老大安排了我去搞一下公司的WebView模块, 也算是换换脑子.</p>
<p>该文章记录一下几个在开发过程中的小经验</p>
<ul>
<li><p>当你使用WebView加载网页的时候, 如果这个网页有JavaScript, 你要跟它进行交互的话,你需要打开开关.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebView.getSetting.setJavaScriptEnabled(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Java与JavaScript 交互比较关键的一个方法是 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebView.addJavascriptInterface(Object, String);</span><br></pre></td></tr></table></figure>
<p>这个方法简单的来说<br>就是往JavaScript 注入一个可以供他们使用,进行回调的Object, String 就是 这个Object的名字.<br>举例来说:<br>比如 我们在Java代码中 写了这样一段代码  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WebView.addJavascriptInterface(<span class="keyword">new</span> Object()&#123;</span><br><span class="line">     <span class="meta">@JavascriptInterface</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        Log.d(TAG, <span class="string">"Inject success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">"InjectObject"</span>);</span><br></pre></td></tr></table></figure>
<p>而在Javascript中 代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InjectObject.inject(<span class="string">"hi, i'm Javascript"</span>);</span><br></pre></td></tr></table></figure>
<p>这样Java中就可以回调打印出Inject success的字段.<br>这里需要特殊说明的一点就是 addJavascriptInterface的Object 中必须有一个方法是声明 @JavascriptInterface 的, 否则是无法add进去的.<br>并且只有声明了 @JavascriptInterface 的方法 才能被JavaScript 成功调用.  </p>
</li>
<li>Java 和 Javascript 交互的本质是字符串的传递.<br>Java 无论你上层如何封装, 最终将字符串从Java 传到Javascript 都是需要这样去传递的.<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebView.loadUrl(<span class="string">"javascript:WebViewJavascriptBridge._handleMessageFromJava('%s')"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>其中 javascript: 是必须的. WebViewJavascriptBridge 是Javascript那边的对象,_handleMessageFromJava 是这个对象所拥有的方法. ()内就是要传递过去的字符串!<br>这里有一点需要注意, loadUrl方法会进行checkThread(); 所以也就是说你必须在MainThread中调用该方法.</p>
<ul>
<li>WebView 有内存泄漏的问题, 属于系统代码的1个bug, 在这里我们做了特殊的 WorkAround.<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           MagicWebView thiz = <span class="keyword">this</span>;</span><br><span class="line">           thiz.setWebViewClient(<span class="keyword">null</span>);</span><br><span class="line">           thiz.setWebChromeClient(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">           Field field = View.class.getDeclaredField(<span class="string">"mContext"</span>);</span><br><span class="line">           field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">           field.set(thiz, getContext().getApplicationContext());</span><br><span class="line">           field.setAccessible(<span class="keyword">false</span>);</span><br><span class="line">           field = View.class.getDeclaredField(<span class="string">"mParent"</span>);</span><br><span class="line">           field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">           field.set(thiz, <span class="keyword">null</span>);</span><br><span class="line">           field.setAccessible(<span class="keyword">false</span>);</span><br><span class="line">           field = View.class.getDeclaredField(<span class="string">"mLayoutParams"</span>);</span><br><span class="line">           field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">           field.set(thiz, <span class="keyword">null</span>);</span><br><span class="line">           field.setAccessible(<span class="keyword">false</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这样并不能完全解决WebView 会泄露的问题, WebView 依旧会被泄露, 但是WebView跟相应的Activity 会完全解耦,<br>不会造成Activity也跟着泄露.</p>
<ul>
<li>在Https的网址下,有的H5图片会加载不正常. 这个时候需要加入这样一个设置<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">    getSettings().setMixedContentMode(WebSettings.MIXED_CONTENT_COMPATIBILITY_MODE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://saberpowermo.github.io/2017/02/16/webview/" data-id="cjszrxgv1000tu4kpzbuf56oc" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="/2017/02/16/webview/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="/2017/02/16/webview/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-resume" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2016/11/02/resume/">android工程师简历.</a>
        </h1>
    

                <div class="article-meta">
                    
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2016/11/02/resume/">
            <time datetime="2016-11-02T11:31:30.000Z" itemprop="datePublished">2016-11-02</time>
        </a>
    </div>


                    
                    
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Resume/">Resume</a>
    </div>

                </div>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
        
            
            
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://saberpowermo.github.io/2016/11/02/resume/" data-id="cjszrxguy000ou4kpy4oqkw21" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="/2016/11/02/resume/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="/2016/11/02/resume/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-house" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2016/09/29/house/">购房记.</a>
        </h1>
    

                <div class="article-meta">
                    
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2016/09/29/house/">
            <time datetime="2016-09-29T14:31:30.000Z" itemprop="datePublished">2016-09-29</time>
        </a>
    </div>


                    
                    
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Life/">Life</a>
    </div>

                </div>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>转眼来北京就9年多了,毕业也5年了, 随着年龄越来越大, 以及经历各种合租的痛楚之后,越发的希望自己能有一套自己的房子.<br>原本的计划是在回龙观里买一个商住两用房, 30多平米的那种.<br>买这种小产权的房子也是无奈,北京买房是需要购房资格的,需要连续5年社保.<br>我如果从毕业开始算起,也算是交了5年了,但是中间有一段时间从中华英才网离职,在家学习开发,断交了一段时间.<br>导致我失去了购房资格. 所以如果强行在北京买, 只能买这种小产权的房子.</p>
<p>由于哥哥在回龙观买的房子,所以我毕业以后一直在回龙观这边住,也算是半个观里人了, 对这里比较熟悉,比较依赖.<br>所以优先考虑在回龙观去选了,也基本上只考虑这里了. 仔细观察了下, 符合我要求的房子, 竟然只有一个楼盘.<br>叫东亚上北中心.<br>总结一下这里房子的特点.</p>
<h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h5><ul>
<li>因为面积小,只有37平米附近, 大概需要120w附近,总价相对来说比较低.</li>
</ul>
<h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h5><ul>
<li>小户型. 使用面积只有20多平.</li>
<li>超北 没有阳光</li>
<li>贷款只能走商贷,而且只能10年. 每个月还款压力很大</li>
<li>问了下银行这种房子,我最多只能贷款30w, 也就是说需要至少90W的首付! 这也是一个致命伤, 是我根本承受不起的价格.</li>
<li>以后就算有了孩子,也不能上学.更别说落户了.</li>
</ul>
<h5 id="做决定的那几天想了很多事情-感觉买这种房子的话-一辈子的生活都要搭进去了-而且父母那边也要卖掉老家空置的那套房子-然后再加上哥哥的帮忙-也不一定能凑够首付-所以最后选择了放弃"><a href="#做决定的那几天想了很多事情-感觉买这种房子的话-一辈子的生活都要搭进去了-而且父母那边也要卖掉老家空置的那套房子-然后再加上哥哥的帮忙-也不一定能凑够首付-所以最后选择了放弃" class="headerlink" title="做决定的那几天想了很多事情,感觉买这种房子的话,一辈子的生活都要搭进去了, 而且父母那边也要卖掉老家空置的那套房子,然后再加上哥哥的帮忙,也不一定能凑够首付. 所以最后选择了放弃."></a>做决定的那几天想了很多事情,感觉买这种房子的话,一辈子的生活都要搭进去了, 而且父母那边也要卖掉老家空置的那套房子,然后再加上哥哥的帮忙,也不一定能凑够首付. 所以最后选择了放弃.</h5><p>然后买房这件事就暂时冷了下来,我开始静下来考虑一些漫无边际的事情,大概就是人生啊,生活啊,以后啊云云的.<br>思索了几个月也没思索出什么结果, 反倒是之前看的那个房子又涨了几十万….北京的房子真是令人不能琢磨啊.<br>但是这种漫无边际的涨价到是坚定了我买房的心.<br>脑子不知道怎么回事就冒出了去济南买房的念头,然后跟父母大概提了下,父母对这件事也一直很是上心,是他们的一个心病.<br>考虑去济南的原因大概有这么几个</p>
<ul>
<li>济南IT行业虽然说不是很好,但是还是有的.以后去的话还是可以做相关的工作.</li>
<li>是山东的省会,作为一个山东人回自己的省会发展还是说的过去的.</li>
<li>房价还算温和, 除了东面高新区猛涨以外,西面南面还是很靠谱的.</li>
<li>离北京很近,高铁1个半小时就到了. 离菏泽也不远,如果菏泽开了动车以后,应该也是2个小时以内的行程.</li>
<li>济南有很多老家的朋友 和 亲戚.</li>
</ul>
<p>父母也是做了决定以后, 立马就动身去了济南, 不过一开始看房的方向是有点选错了,这也是我的问题.<br>因为我一直在北京的缘故, 总是不由自主的去考虑二手房, 导致我父母浪费了很多时间去看二手房,<br>济南的二手房都是那种很破很烂的那种,并且价格很高.<br>最后立哥带着我父母去了一个新的楼盘,恒大的房子. 我父母一眼就看中了样板间,然后就跟我开始商量决定要买.<br>我综合考虑了下这房子的优点</p>
<ul>
<li>均价 9100 附近</li>
<li>未来出门就是地铁</li>
<li>离济南大学超近, 不知道为什么,我总感觉离大学近是好事.</li>
<li>离我立哥比较近</li>
<li>送精装修, 先不说是不是羊毛出在羊身上了, 因为我要一直在北京上班,没有时间去管装修的事.</li>
</ul>
<p>虽然现在是列了那么多,但是当时只是脑子已经乱了,每天我在北京上着班,听着父母传来的信息,感觉父母也累到极限了, 也实在是不想<br>让父母再去逛了,于是我立马拍板了,就他了.<br>决定之后也就好说了,第二天4点50就起床然后高铁到了济南, 直接打车到了楼盘, 然后我亲自看了下样板间,看起来确实很不错!<br>然后接下来就一路程序走下来, 认购 -&gt; 去银行面签 -&gt; 然后签合同. 一切算是尘埃落定了吧</p>
<h4 id="下面是房子的一些照片"><a href="#下面是房子的一些照片" class="headerlink" title="下面是房子的一些照片"></a>下面是房子的一些照片</h4><p><img src="/images/huxing.jpg" alt="户型图"></p>
<p><img src="/images/zhuwo.jpg" alt="主卧"></p>
<p><img src="/images/zhuwei.jpg" alt="主卫"></p>
<p><img src="/images/guodao.jpg" alt="过道"></p>
<p><img src="/images/ciwo1.jpg" alt="次卧1"></p>
<p><img src="/images/ciwo2.jpg" alt="次卧2"></p>
<p><img src="/images/keting.jpg" alt="客厅"></p>
<p><img src="/images/keting2.jpg" alt="客厅换了个角度"></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://saberpowermo.github.io/2016/09/29/house/" data-id="cjszrxguf0004u4kpn7nzn5fu" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="/2016/09/29/house/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="/2016/09/29/house/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
</section>
            
                <aside id="sidebar">
    
        
    <div class="widget-wrap">
        <h3 class="widget-title">recent</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2019/03/08/center-os-mysql/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2019/03/08/center-os-mysql/" class="title">center os 通过yum 安装 mysql 5.7</a></p>
                            <p class="item-date"><time datetime="2019-03-08T06:58:30.000Z" itemprop="datePublished">2019-03-08</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/07/11/nginx_go_server/" class="thumbnail">
    
    
        <span style="background-image:url(/images/nginx_default.png)" alt="nginx &amp;&amp; 定向本地静态资源 &amp;&amp; 反代 golang 服务 " class="thumbnail-image"></span>
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2018/07/11/nginx_go_server/" class="title">nginx &amp;&amp; 定向本地静态资源 &amp;&amp; 反代 golang 服务 </a></p>
                            <p class="item-date"><time datetime="2018-07-11T08:58:30.000Z" itemprop="datePublished">2018-07-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/09/26/lottie/" class="thumbnail">
    
    
        <span style="background-image:url(/images/lottie_test0.gif)" alt="Lottie 源码阅读." class="thumbnail-image"></span>
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/09/26/lottie/" class="title">Lottie 源码阅读.</a></p>
                            <p class="item-date"><time datetime="2017-09-26T06:31:30.000Z" itemprop="datePublished">2017-09-26</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/09/14/volley/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/09/14/volley/" class="title">Volley 源码阅读.</a></p>
                            <p class="item-date"><time datetime="2017-09-14T06:31:30.000Z" itemprop="datePublished">2017-09-14</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/05/01/viewsavastate/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/05/01/viewsavastate/" class="title">正确的保存View状态.</a></p>
                            <p class="item-date"><time datetime="2017-05-01T02:31:30.000Z" itemprop="datePublished">2017-05-01</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    
        
    <div class="widget-wrap">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tags</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Life/">Life</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Resume/">Resume</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/server/">server</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Life/" style="font-size: 15px;">Life</a> <a href="/tags/Resume/" style="font-size: 10px;">Resume</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/server/" style="font-size: 10px;">server</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://blog.aquariuslt.com/">英俊的小A</a>
                    </li>
                
                    <li>
                        <a href="http://lousama.com/">楼总</a>
                    </li>
                
                    <li>
                        <a href="http://songyuqiang.com/">强神</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2019 bb<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_shortname = 'saberpowermo';
    
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>



    
        <script src="/vendor/fancybox/jquery.fancybox.pack.js"></script>
    


<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>